version: "3.8"

services:
  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    command:
      - start-dev
      - --https-port=8443
      - --https-key-store-file=/opt/keycloak/conf/keycloak-keystore.p12
      - --https-key-store-password=password
      - --hostname-strict=false
      - --hostname-url=https://localhost:9443
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "9443:8443"
    volumes:
      - ./keycloak_certs/keycloak-keystore.p12:/opt/keycloak/conf/keycloak-keystore.p12
      - ./keycloak_data:/opt/keycloak/data # üß± persist data here
    networks:
      - app-network

  # ‚öôÔ∏è Spring Boot API with HTTPS
  api:
    build:
      context: ./API
      dockerfile: Dockerfile
    environment:
      SPRING_APPLICATION_NAME: demo
      SERVER_PORT: 8443
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_KEY_STORE: /app/keystore.p12
      SERVER_SSL_KEY_STORE_PASSWORD: 123456
      SERVER_SSL_KEY_STORE_TYPE: PKCS12
      SERVER_SSL_KEY_ALIAS: api-cert
      KEYCLOAK_ISSUER_URI: https://keycloak:8443/realms/parcial-realm
    ports:
      - "9444:8443" # host 9444 -> container 8443
    depends_on:
      - keycloak
    volumes:
      - ./API/src/main/resources/keystore.p12:/app/keystore.p12
    networks:
      - app-network

  # üåê Frontend (Vite / React)
  frontend:
    build:
      context: ./Frontend/Logiin
      dockerfile: Dockerfile.dev
    command: npm run dev -- --host 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      - ./Frontend/Logiin:/app
      - /app/node_modules
      - ./Frontend/Logiin/certs:/certs
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_URL=https://api:8443
      - VITE_KEYCLOAK_URL=https://localhost:9443
    depends_on:
      - api
    networks:
      - app-network

# üåê Shared network
networks:
  app-network:
    driver: bridge
