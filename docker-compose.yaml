services:
  keycloak:
    build:
      context: ./
      dockerfile: Dockerfile.keycloak
    image: secure-keycloak:latest
    command:
      - start-dev
      - --http-enabled=true
      - --http-port=8080
      - --https-port=8443
      - --hostname-strict=false
      - --hostname-strict-https=false
    environment:
      KEYCLOAK_ADMIN_FILE: /run/secrets/KEYCLOAK_ADMIN
      KEYCLOAK_ADMIN_PASSWORD_FILE: /run/secrets/KEYCLOAK_ADMIN_PASSWORD
      KC_PROXY: edge
    ports:
      - "9443:8443" # HTTPS (external frontend login)
      - "8080:8080" # HTTP (internal API communication)
    volumes:
      - ./keycloak_certs:/opt/keycloak/conf
      - ./keycloak_data:/opt/keycloak/data
    secrets:
      - KEYCLOAK_ADMIN
      - KEYCLOAK_ADMIN_PASSWORD
    networks:
      - app-network

  api:
    build:
      context: ./API
      dockerfile: Dockerfile
    environment:
      SPRING_APPLICATION_NAME: ecommerce-api
      SERVER_PORT: 8443
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_KEY_STORE: /app/keystore.p12
      SERVER_SSL_KEY_STORE_PASSWORD: ${SERVER_SSL_KEY_STORE_PASSWORD:-123456}
      SERVER_SSL_KEY_STORE_TYPE: PKCS12
      SERVER_SSL_KEY_ALIAS: api-cert

      # ðŸŽ¯ KEY FIX: Read secret from file and set as environment variable
      KEYCLOAK_CLIENT_SECRET_FILE: /run/secrets/KEYCLOAK_BACKEND_CLIENT_SECRET

      # Other Keycloak settings
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: Ecommerce
      KEYCLOAK_CLIENT_ID: backend-client
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/Ecommerce
      KEYCLOAK_RESOURCE: backend-client
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
      KEYCLOAK_SSL_REQUIRED: none

    ports:
      - "9444:8443"
    depends_on:
      - keycloak
    volumes:
      - ./API/src/main/resources/keystore.p12:/app/keystore.p12:ro
    secrets:
      - KEYCLOAK_BACKEND_CLIENT_SECRET
    networks:
      - app-network

  frontend:
    build:
      context: ./Frontend/Logiin
      dockerfile: Dockerfile.dev
    command: npm run dev -- --host 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      - ./Frontend/Logiin:/app
      - /app/node_modules
      - ./Frontend/Logiin/certs:/certs
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_URL=https://localhost:9444
      - VITE_KEYCLOAK_URL=https://localhost:9443
    depends_on:
      - api
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

secrets:
  KEYCLOAK_ADMIN:
    file: ./secrets/KEYCLOAK_ADMIN.txt
  KEYCLOAK_ADMIN_PASSWORD:
    file: ./secrets/KEYCLOAK_ADMIN_PASSWORD.txt
  SERVER_SSL_KEY_STORE_PASSWORD:
    file: ./secrets/SERVER_SSL_KEY_STORE_PASSWORD.txt
  KEYCLOAK_BACKEND_CLIENT_SECRET:
    file: ./secrets/KEYCLOAK_BACKEND_CLIENT_SECRET.txt
