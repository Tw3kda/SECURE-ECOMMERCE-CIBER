services:
  keycloak:
    build:
      context: ./
      dockerfile: Dockerfile.keycloak
    image: secure-keycloak:latest
    command:
      - start-dev
      - --http-enabled=true
      - --http-port=8080
      - --https-port=8443
      - --hostname-strict=false
      - --hostname-strict-https=false
    environment:
      KEYCLOAK_ADMIN_FILE: /run/secrets/KEYCLOAK_ADMIN
      KEYCLOAK_ADMIN_PASSWORD_FILE: /run/secrets/KEYCLOAK_ADMIN_PASSWORD
      KC_PROXY: edge
    ports:
      - "9443:8443" # HTTPS (external frontend login)
      - "8080:8080" # HTTP (internal API communication)
    volumes:
      - ./keycloak_certs:/opt/keycloak/conf
      - ./keycloak_data:/opt/keycloak/data
    secrets:
      - KEYCLOAK_ADMIN
      - KEYCLOAK_ADMIN_PASSWORD
    networks:
      - app-network

  api:
    build:
      context: ./API
      dockerfile: Dockerfile
    environment:
      SPRING_APPLICATION_NAME: ecommerce-api
      SERVER_PORT: 8443
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_KEY_STORE: /app/keystore.p12
      # üö® CAMBIO CR√çTICO: Usar valor directo en lugar de archivo
      SERVER_SSL_KEY_STORE_PASSWORD: "123456"
      SERVER_SSL_KEY_STORE_TYPE: PKCS12
      SERVER_SSL_KEY_ALIAS: api-cert

      # Database Configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/ecommerce
      SPRING_DATASOURCE_USERNAME: postgres
      # üö® CAMBIO: Usar valor directo en lugar de archivo
      SPRING_DATASOURCE_PASSWORD: "postgres_password"
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect

      # üö® CAMBIO: Leer secret y asignar a variable
      KEYCLOAK_CLIENT_SECRET_FILE: /run/secrets/KEYCLOAK_BACKEND_CLIENT_SECRET

      # Other Keycloak settings
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: Ecommerce
      KEYCLOAK_CLIENT_ID: backend-client
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/Ecommerce
      KEYCLOAK_RESOURCE: backend-client
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
      KEYCLOAK_SSL_REQUIRED: none

      CLAMAV_HOST: clamav
      CLAMAV_PORT: 3310

    ports:
      - "9444:8443"
    depends_on:
      - keycloak
      - db
    volumes:
      - ./API/src/main/resources/keystore.p12:/app/keystore.p12:ro
    secrets:
      - KEYCLOAK_BACKEND_CLIENT_SECRET
      # üö® REMOVER: SERVER_SSL_KEY_STORE_PASSWORD y DB_PASSWORD de secrets
    networks:
      - app-network

  frontend:
    build:
      context: ./Frontend/Logiin
      dockerfile: Dockerfile.dev
    command: npm run dev -- --host 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      # Mount only specific directories for live reload, not the entire app
      - ./Frontend/Logiin/src:/app/src
      - ./Frontend/Logiin/public:/app/public
      - ./Frontend/Logiin/certs:/certs
      # Mount config files
      - ./Frontend/Logiin/vite.config.js:/app/vite.config.js
      - ./Frontend/Logiin/index.html:/app/index.html
      - ./Frontend/Logiin/package.json:/app/package.json
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_URL=https://localhost:9444
      - VITE_KEYCLOAK_URL=https://localhost:9443
    depends_on:
      - api
    networks:
      - app-network

  # Use postgres/example user/password credentials

  db:
    image: postgres:13
    container_name: secure-ecommerce-ciber-db-1
    restart: always
    environment:
      POSTGRES_DB: ecommerce
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_password
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - app-network

  adminer:
    image: adminer
    restart: always
    ports:
      - 8085:8081
    networks:
      - app-network

  clamav:
    image: clamav/clamav:latest
    container_name: clamav
    restart: unless-stopped
    ports:
      - "3310:3310"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "3310"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

# ‚úÖ DEFINIR LOS VOLUMENES
volumes:
  postgres_data:
    driver: local

  db_data:

secrets:
  KEYCLOAK_ADMIN:
    file: ./secrets/KEYCLOAK_ADMIN.txt
  KEYCLOAK_ADMIN_PASSWORD:
    file: ./secrets/KEYCLOAK_ADMIN_PASSWORD.txt
  SERVER_SSL_KEY_STORE_PASSWORD:
    file: ./secrets/SERVER_SSL_KEY_STORE_PASSWORD.txt
  KEYCLOAK_BACKEND_CLIENT_SECRET:
    file: ./secrets/KEYCLOAK_BACKEND_CLIENT_SECRET.txt
  DB_PASSWORD:
    file: ./secrets/DB_PASSWORD.txt
